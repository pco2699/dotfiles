#!/bin/bash

set -e

echo "Installing packages for {{ .chezmoi.os }} ({{ .osid }})..."

{{- if eq .chezmoi.os "darwin" }}
# macOS (Homebrew)
brew update
brew install fish
brew install tmux
brew install neovim
brew install go
brew install ghq
brew install peco
brew install gh fd ripgrep zoxide bat fzf
# TODO: add powerline

{{- else if eq .osid "linux-ubuntu" }}
# Ubuntu/Debian
if [ ! -f /usr/share/keyrings/githubcli-archive-keyring.gpg ]; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
fi
if [ ! -f /etc/apt/sources.list.d/github-cli.list ]; then
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
fi
sudo apt-add-repository -y ppa:fish-shell/release-3
sudo apt update
sudo apt -y install gpg
sudo apt -y install fish tmux peco gh zip fd ripgrep zoxide bat fzf eza

# clipboard tools (Wayland and X11) - only on desktop environments
if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
    sudo apt -y install wl-clipboard xclip
fi

# required by asdf
sudo apt -y install dirmngr curl gawk

# required by python
sudo apt -y install build-essential libssl-dev zlib1g-dev \
    libbz2-dev libreadline-dev libsqlite3-dev curl git \
    libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

# install nvim
if [ ! -f ~/.local/bin/nvim ]; then
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
    tar -C ~/.local/ --strip-components 1 -xzf nvim-linux-x86_64.tar.gz
    rm -rf ~/.local/bin/README.md
    rm -rf ~/.local/bin/LICENSE
    rm -rf nvim-linux-x86_64.tar.gz
fi

{{- if (or (contains "microsoft" (.chezmoi.kernel.osrelease | lower)) (contains "wsl" (.chezmoi.kernel.osrelease | lower))) }}
# install win32yank (WSL only)
if [ ! -f ~/.local/bin/win32yank.exe ]; then
    curl -LO https://github.com/equalsraf/win32yank/releases/download/v0.1.1/win32yank-x64.zip
    unzip -o win32yank-x64.zip -d ~/.local/bin
    rm -rf win32yank-x64.zip
fi
{{- end }}

{{- else if eq .osid "linux-debian" }}
# Debian
if [ ! -f /usr/share/keyrings/githubcli-archive-keyring.gpg ]; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
fi
if [ ! -f /etc/apt/sources.list.d/github-cli.list ]; then
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
fi
sudo apt update
sudo apt -y install gpg
sudo apt -y install fish tmux peco gh zip fd ripgrep zoxide bat fzf eza

# clipboard tools (Wayland and X11) - only on desktop environments
if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
    sudo apt -y install wl-clipboard xclip
fi

# required by asdf
sudo apt -y install dirmngr curl gawk

# required by python
sudo apt -y install build-essential libssl-dev zlib1g-dev \
    libbz2-dev libreadline-dev libsqlite3-dev curl git \
    libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev

# install nvim
if [ ! -f ~/.local/bin/nvim ]; then
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
    tar -C ~/.local/ --strip-components 1 -xzf nvim-linux-x86_64.tar.gz
    rm -rf ~/.local/bin/README.md
    rm -rf ~/.local/bin/LICENSE
    rm -rf nvim-linux-x86_64.tar.gz
fi

{{- if (or (contains "microsoft" (.chezmoi.kernel.osrelease | lower)) (contains "wsl" (.chezmoi.kernel.osrelease | lower))) }}
# install win32yank (WSL only)
if [ ! -f ~/.local/bin/win32yank.exe ]; then
    curl -LO https://github.com/equalsraf/win32yank/releases/download/v0.1.1/win32yank-x64.zip
    unzip -o win32yank-x64.zip -d ~/.local/bin
    rm -rf win32yank-x64.zip
fi
{{- end }}

{{- else if eq .osid "linux-fedora" }}
# Fedora
sudo dnf install -y dnf-plugins-core
if [ ! -f /etc/yum.repos.d/gh-cli.repo ]; then
    sudo dnf config-manager addrepo --from-repofile=https://cli.github.com/packages/rpm/gh-cli.repo
fi
sudo dnf install -y fish tmux gh zip neovim fzf fd ripgrep zoxide bat

# peco (not available in Fedora repos, install from GitHub releases)
if [ ! -f ~/.local/bin/peco ]; then
    PECO_VERSION=$(curl -s https://api.github.com/repos/peco/peco/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    curl -LO https://github.com/peco/peco/releases/download/v${PECO_VERSION}/peco_linux_amd64.tar.gz
    tar xzf peco_linux_amd64.tar.gz
    mkdir -p ~/.local/bin
    mv peco_linux_amd64/peco ~/.local/bin/
    rm -rf peco_linux_amd64 peco_linux_amd64.tar.gz
fi

# clipboard tools (Wayland and X11) - only on desktop environments
if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
    sudo dnf install -y wl-clipboard xclip
fi

# required by asdf
sudo dnf install -y curl git gawk

# required by python
sudo dnf install -y gcc make zlib-devel bzip2 bzip2-devel readline-devel \
    sqlite sqlite-devel openssl-devel tk-devel libffi-devel xz-devel

{{- else }}
# Generic Linux - install what we can
echo "Unsupported OS: {{ .osid }}"
echo "Please install packages manually: fish, tmux, neovim, gh, peco, zip"
{{- end }}

# install asdf
if [ ! -d ~/.asdf ]; then
    git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.1
fi
source "$HOME/.asdf/asdf.sh"

# tmux plugin manager
if [ ! -d ~/.tmux/plugins/tpm ]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

{{- if eq .chezmoi.os "darwin" }}
asdf reshim python
{{- end }}

# ghq setup
mkdir -p ~/.ghq
git config --global ghq.root "~/.ghq"


# install fisher (fish plugin manager)
if [ "$CODESPACES" != true ]; then
    fish -c "curl -sL https://git.io/fisher | source; fisher update" || true

    # install asdf plugins
    asdf plugin add nodejs 2>/dev/null || true
    asdf install nodejs latest
    asdf global nodejs latest

    asdf plugin-add python 2>/dev/null || true
    asdf install python latest
    asdf global python latest

    asdf plugin-add golang 2>/dev/null || true
    asdf install golang latest
    asdf global golang latest

    asdf plugin-add zig 2>/dev/null || true
    asdf install zig latest
    asdf global zig latest

    asdf plugin-add ghq 2>/dev/null || true
    asdf install ghq latest
    asdf global ghq latest


    {{- if eq .osid "linux-fedora" }}
      asdf plugin-add eza 2>/dev/null || true
      asdf install eza latest
      asdf global eza latest
    {{- end }}
    echo "================================================"
    echo "Installation complete!"
    echo "Run 'chsh -s /usr/bin/fish' to set fish as your default shell"
    echo "================================================"
fi
