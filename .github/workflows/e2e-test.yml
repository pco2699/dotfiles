name: E2E Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-linux:
    name: Test on ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            image: ubuntu:latest
            osid: linux-ubuntu
          - os: debian
            image: debian:bookworm
            osid: linux-debian
          - os: fedora
            image: fedora:latest
            osid: linux-fedora

    container:
      image: ${{ matrix.image }}

    steps:
      - name: Install dependencies (Ubuntu/Debian)
        if: matrix.os == 'ubuntu' || matrix.os == 'debian'
        run: |
          apt-get update
          apt-get install -y sudo curl git ca-certificates

      - name: Install dependencies (Fedora)
        if: matrix.os == 'fedora'
        run: |
          dnf install -y sudo curl git tar gzip findutils

      - name: Create test user
        run: |
          useradd -m -s /bin/bash testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

      - name: Checkout dotfiles
        uses: actions/checkout@v4
        with:
          path: /tmp/dotfiles-repo

      - name: Install chezmoi and apply dotfiles
        shell: bash
        run: |
          # Switch to test user and run chezmoi
          su - testuser -c "
            set -e

            # Install chezmoi
            export PATH=\$HOME/.local/bin:\$PATH
            sh -c \"\$(curl -fsLS get.chezmoi.io)\" -- -b ~/.local/bin

            # Initialize chezmoi with local repo
            ~/.local/bin/chezmoi init --apply /tmp/dotfiles-repo
          "

      - name: Verify installation
        shell: bash
        run: |
          su - testuser -c "
            set -e
            export PATH=\$HOME/.local/bin:\$HOME/.asdf/shims:\$PATH

            # Check if fish is installed
            which fish || echo 'fish not found in PATH'

            # Check if tmux is installed
            which tmux && tmux -V || echo 'tmux not found'

            # Check if nvim is installed
            which nvim && nvim --version | head -n 1 || echo 'nvim not found'

            # Check if asdf is installed
            if [ -d ~/.asdf ]; then
              echo 'asdf installed'
              source ~/.asdf/asdf.sh
              asdf --version || echo 'asdf command failed'
            else
              echo 'asdf not installed'
            fi

            # Check basic config files
            test -f ~/.config/fish/config.fish && echo 'fish config exists' || echo 'fish config missing'
            test -f ~/.tmux.conf && echo 'tmux config exists' || echo 'tmux config missing'
            test -f ~/.gitconfig && echo 'git config exists' || echo 'git config missing'
          "

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout dotfiles
        uses: actions/checkout@v4

      - name: Install chezmoi and apply dotfiles
        run: |
          # Install chezmoi
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
          export PATH=$HOME/.local/bin:$PATH

          # Initialize chezmoi with local repo
          chezmoi init --apply $GITHUB_WORKSPACE

      - name: Verify installation
        run: |
          export PATH=$HOME/.local/bin:$HOME/.asdf/shims:$PATH

          # Check if fish is installed
          which fish && fish --version || echo 'fish not found'

          # Check if tmux is installed
          which tmux && tmux -V || echo 'tmux not found'

          # Check if nvim is installed
          which nvim && nvim --version | head -n 1 || echo 'nvim not found'

          # Check if asdf is installed
          if [ -d ~/.asdf ]; then
            echo 'asdf installed'
            source ~/.asdf/asdf.sh
            asdf --version || echo 'asdf command failed'
          else
            echo 'asdf not installed'
          fi

          # Check basic config files
          test -f ~/.config/fish/config.fish && echo 'fish config exists' || echo 'fish config missing'
          test -f ~/.tmux.conf && echo 'tmux config exists' || echo 'tmux config missing'
          test -f ~/.gitconfig && echo 'git config exists' || echo 'git config missing'
